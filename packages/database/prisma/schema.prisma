// ===========================================
// Made in France - Database Schema
// ===========================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pg_trgm]
}

// ===========================================
// ENUMS
// ===========================================

enum MadeInFranceLevel {
  FABRICATION_100_FRANCE
  ASSEMBLE_FRANCE
  CONCU_FRANCE
  MATIERE_FRANCE
  ENTREPRISE_FRANCAISE
  MIXTE
}

enum BrandStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE
  SUSPENDED
  REJECTED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  OUT_OF_STOCK
  DISCONTINUED
}

enum SubscriptionTier {
  FREE
  PREMIUM
  ROYALE
}

enum EventType {
  BRAND_PAGE_VIEW
  PRODUCT_PAGE_VIEW
  SEARCH_RESULTS_VIEW
  SEARCH_QUERY
  FILTER_APPLIED
  MAP_INTERACTION
  CLICK_OUT
  AFFILIATE_CLICK
  ADD_TO_FAVORITES
  AI_CONVERSATION
  AI_RECOMMENDATION_SHOWN
  AI_RECOMMENDATION_CLICKED
  BRAND_DASHBOARD_VIEW
  CAMPAIGN_CREATED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum BrandOwnerRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// ===========================================
// REFERENCE DATA
// ===========================================

model Region {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  centerLat   Float?   @map("center_lat")
  centerLng   Float?   @map("center_lng")
  bbox        Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  departments Department[]
  brands      Brand[]

  @@map("regions")
}

model Department {
  id        String   @id @default(uuid())
  regionId  String   @map("region_id")
  name      String
  code      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  region Region  @relation(fields: [regionId], references: [id])
  brands Brand[]

  @@map("departments")
}

model Sector {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  icon      String?
  color     String?
  createdAt DateTime @default(now()) @map("created_at")

  brands     Brand[]
  categories Category[]

  @@map("sectors")
}

model Category {
  id          String   @id @default(uuid())
  parentId    String?  @map("parent_id")
  sectorId    String?  @map("sector_id")
  name        String
  slug        String   @unique
  description String?
  level       Int      @default(0)
  path        String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  sector   Sector?    @relation(fields: [sectorId], references: [id])

  brands   BrandCategory[]
  products Product[]

  @@map("categories")
}

model Label {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  logoUrl     String?  @map("logo_url")
  websiteUrl  String?  @map("website_url")
  createdAt   DateTime @default(now()) @map("created_at")

  brands   BrandLabel[]
  products ProductLabel[]

  @@map("labels")
}

// ===========================================
// BRANDS
// ===========================================

model Brand {
  id               String             @id @default(uuid())
  
  name             String
  slug             String             @unique
  tagline          String?
  descriptionShort String?            @map("description_short")
  descriptionLong  String?            @map("description_long")
  story            String?
  
  logoUrl          String?            @map("logo_url")
  coverImageUrl    String?            @map("cover_image_url")
  galleryUrls      Json               @default("[]") @map("gallery_urls")
  videoUrl         String?            @map("video_url")
  
  regionId         String?            @map("region_id")
  departmentId     String?            @map("department_id")
  city             String?
  address          String?
  postalCode       String?            @map("postal_code")
  latitude         Float?
  longitude        Float?
  
  sectorId         String?            @map("sector_id")
  madeInFranceLevel MadeInFranceLevel @default(MIXTE) @map("made_in_france_level")
  yearFounded      Int?               @map("year_founded")
  employeeRange    String?            @map("employee_count_range")
  
  websiteUrl       String?            @map("website_url")
  socialLinks      Json               @default("{}") @map("social_links")
  
  affiliateProgram String?            @map("affiliate_program")
  affiliateId      String?            @map("affiliate_id")
  affiliateBaseUrl String?            @map("affiliate_base_url")
  commissionRate   Float?             @map("commission_rate")
  
  status           BrandStatus        @default(DRAFT)
  isVerified       Boolean            @default(false) @map("is_verified")
  isFeatured       Boolean            @default(false) @map("is_featured")
  isSponsored      Boolean            @default(false) @map("is_sponsored")
  sponsoredUntil   DateTime?          @map("sponsored_until")
  
  subscriptionTier SubscriptionTier   @default(FREE) @map("subscription_tier")
  subscriptionExpiresAt DateTime?     @map("subscription_expires_at")
  stripeCustomerId String?            @map("stripe_customer_id")
  stripeSubscriptionId String?        @map("stripe_subscription_id")
  
  seoTitle         String?            @map("seo_title")
  seoDescription   String?            @map("seo_description")
  
  aiGeneratedContent Json             @default("{}") @map("ai_generated_content")
  
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  publishedAt      DateTime?          @map("published_at")
  
  region           Region?            @relation(fields: [regionId], references: [id])
  department       Department?        @relation(fields: [departmentId], references: [id])
  sector           Sector?            @relation(fields: [sectorId], references: [id])
  
  categories       BrandCategory[]
  labels           BrandLabel[]
  products         Product[]
  events           Event[]
  analyticsDaily   BrandAnalyticsDaily[]
  campaigns        Campaign[]
  favoritedBy      Favorite[]
  views            BrandView[]
  collectionBrands CollectionBrand[]
  featuredBrands   FeaturedBrand[]
  trendingBrands   TrendingBrand[]
  owners           BrandOwner[]
  claimRequests    BrandClaimRequest[]
  images       BrandImage[]

  @@index([status])
  @@index([sectorId])
  @@index([regionId])
  @@index([isFeatured])
  @@index([isSponsored])
  @@map("brands")
}

model BrandImage {
  id        String   @id @default(uuid())
  brandId   String   @map("brand_id")
  url       String
  publicId  String?  @map("public_id")
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("brand_images")
}

model BrandCategory {
  brandId    String  @map("brand_id")
  categoryId String  @map("category_id")
  isPrimary  Boolean @default(false) @map("is_primary")

  brand    Brand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([brandId, categoryId])
  @@map("brand_categories")
}

model BrandLabel {
  brandId String @map("brand_id")
  labelId String @map("label_id")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([brandId, labelId])
  @@map("brand_labels")
}

// ===========================================
// PRODUCTS
// ===========================================

model Product {
  id               String        @id @default(uuid())
  brandId          String        @map("brand_id")
  
  name             String
  slug             String
  descriptionShort String?       @map("description_short")
  descriptionLong  String?       @map("description_long")
  
  imageUrl         String?       @map("image_url")
  galleryUrls      Json          @default("[]") @map("gallery_urls")
  
  categoryId       String?       @map("category_id")
  
  priceMin         Float?        @map("price_min")
  priceMax         Float?        @map("price_max")
  currency         String        @default("EUR")
  
  manufacturingLocation String?  @map("manufacturing_location")
  materials        Json          @default("[]")
  madeInFranceLevel MadeInFranceLevel? @map("made_in_france_level")
  
  externalBuyUrl   String?       @map("external_buy_url")
  affiliateUrl     String?       @map("affiliate_url")
  
  tags             Json          @default("[]")
  attributes       Json          @default("{}")
  
  status           ProductStatus @default(DRAFT)
  isFeatured       Boolean       @default(false) @map("is_featured")
  isSponsored      Boolean       @default(false) @map("is_sponsored")
  
  seoTitle         String?       @map("seo_title")
  seoDescription   String?       @map("seo_description")
  
  aiSellingPoints  Json          @default("[]") @map("ai_selling_points")
  
  externalId       String?       @map("external_id")
  externalSource   String?       @map("external_source")
  externalData     String?       @map("external_data")
  
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  
  brand            Brand         @relation(fields: [brandId], references: [id], onDelete: Cascade)
  category         Category?     @relation(fields: [categoryId], references: [id])
  
  labels           ProductLabel[]
  events           Event[]

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([categoryId])
  @@index([status])
  @@index([externalSource, externalId])
  @@map("products")
}

model ProductLabel {
  productId String @map("product_id")
  labelId   String @map("label_id")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  label   Label   @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([productId, labelId])
  @@map("product_labels")
}

// ===========================================
// USERS & AUTH (NextAuth.js)
// ===========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  
  points        Int       @default(0)
  rank          String    @default("Explorateur")
  
  preferences   Json      @default("{}")
  
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  accounts      Account[]
  sessions      Session[]
  favorites     Favorite[]
  brandViews    BrandView[]
  conversations AiConversation[]
  ownedBrands   BrandOwner[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ===========================================
// USER INTERACTIONS
// ===========================================

model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  brandId   String   @map("brand_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([userId, brandId])
  @@map("favorites")
}

model BrandView {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  brandId   String   @map("brand_id")
  viewedAt  DateTime @default(now()) @map("viewed_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt(sort: Desc)])
  @@map("brand_views")
}

// ===========================================
// BRAND OWNERSHIP & CLAIMS
// ===========================================

model BrandOwner {
  id        String         @id @default(uuid())
  brandId   String         @map("brand_id")
  userId    String         @map("user_id")
  role      BrandOwnerRole @default(EDITOR)
  
  invitedBy String?        @map("invited_by")
  invitedAt DateTime       @default(now()) @map("invited_at")
  acceptedAt DateTime?     @map("accepted_at")
  
  isActive  Boolean        @default(true) @map("is_active")
  
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([brandId, userId])
  @@index([userId])
  @@map("brand_owners")
}

model BrandClaimRequest {
  id              String      @id @default(uuid())
  brandId         String      @map("brand_id")
  
  email           String
  firstName       String      @map("first_name")
  lastName        String      @map("last_name")
  phone           String?
  jobTitle        String?     @map("job_title")
  companyRole     String?     @map("company_role")
  
  proofType       String      @map("proof_type")
  proofDetails    String?     @map("proof_details")
  proofDocumentUrl String?    @map("proof_document_url")
  
  verificationCode String?    @map("verification_code")
  verificationSentAt DateTime? @map("verification_sent_at")
  verifiedAt      DateTime?   @map("verified_at")
  
  status          ClaimStatus @default(PENDING)
  reviewedBy      String?     @map("reviewed_by")
  reviewedAt      DateTime?   @map("reviewed_at")
  reviewNotes     String?     @map("review_notes")
  
  userId          String?     @map("user_id")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([email])
  @@index([status])
  @@map("brand_claim_requests")
}

// ===========================================
// ANALYTICS & EVENTS
// ===========================================

model Event {
  id        String    @id @default(uuid())
  
  eventType EventType @map("event_type")
  userId    String?   @map("user_id")
  sessionId String?   @map("session_id")
  
  brandId   String?   @map("brand_id")
  productId String?   @map("product_id")
  
  metadata  Json      @default("{}")
  
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")
  referrer  String?
  
  country   String?
  region    String?
  city      String?
  
  createdAt DateTime  @default(now()) @map("created_at")

  brand   Brand?   @relation(fields: [brandId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([brandId, createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("events")
}

model BrandAnalyticsDaily {
  id               String   @id @default(uuid())
  brandId          String   @map("brand_id")
  date             DateTime @db.Date
  
  pageViews        Int      @default(0) @map("page_views")
  uniqueVisitors   Int      @default(0) @map("unique_visitors")
  clickOuts        Int      @default(0) @map("click_outs")
  affiliateClicks  Int      @default(0) @map("affiliate_clicks")
  searchImpressions Int     @default(0) @map("search_impressions")
  favoritesAdded   Int      @default(0) @map("favorites_added")
  
  topSearchQueries Json     @default("[]") @map("top_search_queries")
  visitorsByRegion Json     @default("{}") @map("visitors_by_region")
  
  createdAt        DateTime @default(now()) @map("created_at")

  brand Brand @relation(fields: [brandId], references: [id])

  @@unique([brandId, date])
  @@map("brand_analytics_daily")
}

// ===========================================
// CAMPAIGNS
// ===========================================

model Campaign {
  id             String         @id @default(uuid())
  brandId        String         @map("brand_id")
  
  name           String
  description    String?
  
  targetIntents  Json           @default("[]") @map("target_intents")
  targetCategories Json         @default("[]") @map("target_categories")
  targetRegions  Json           @default("[]") @map("target_regions")
  
  budgetTotal    Float?         @map("budget_total")
  budgetDaily    Float?         @map("budget_daily")
  budgetSpent    Float          @default(0) @map("budget_spent")
  startDate      DateTime?      @map("start_date") @db.Date
  endDate        DateTime?      @map("end_date") @db.Date
  
  status         CampaignStatus @default(DRAFT)
  
  impressions    Int            @default(0)
  clicks         Int            @default(0)
  
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  brand Brand @relation(fields: [brandId], references: [id])

  @@map("campaigns")
}

// ===========================================
// AI & SEARCH
// ===========================================

model AiConversation {
  id                 String    @id @default(uuid())
  userId             String?   @map("user_id")
  sessionId          String?   @map("session_id")
  
  messages           Json
  parsedIntent       Json?     @map("parsed_intent")
  
  suggestedBrandIds  String[]  @map("suggested_brand_ids")
  suggestedProductIds String[] @map("suggested_product_ids")
  
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([sessionId])
  @@map("ai_conversations")
}

model SearchCache {
  id           String    @id @default(uuid())
  queryHash    String    @unique @map("query_hash")
  queryText    String    @map("query_text")
  parsedFilters Json?    @map("parsed_filters")
  results      Json
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("search_cache")
}

model AiPrompt {
  id            String   @id @default(uuid())
  name          String
  version       Int      @default(1)
  
  systemMessage String?  @map("system_message")
  userTemplate  String?  @map("user_template")
  
  model         String?
  temperature   Float?
  maxTokens     Int?     @map("max_tokens")
  
  isActive      Boolean  @default(true) @map("is_active")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([name, version])
  @@map("ai_prompts")
}

// ===========================================
// SUBSCRIPTIONS & BILLING
// ===========================================

model SubscriptionPlan {
  id                    String           @id @default(uuid())
  tier                  SubscriptionTier @unique
  name                  String
  description           String?
  
  priceMonthly          Float?           @map("price_monthly")
  priceYearly           Float?           @map("price_yearly")
  stripePriceIdMonthly  String?          @map("stripe_price_id_monthly")
  stripePriceIdYearly   String?          @map("stripe_price_id_yearly")
  
  maxProducts           Int?             @map("max_products")
  maxTeamMembers        Int?             @map("max_team_members")
  hasAnalytics          Boolean          @default(false) @map("has_analytics")
  hasAdvancedAnalytics  Boolean          @default(false) @map("has_advanced_analytics")
  hasCampaigns          Boolean          @default(false) @map("has_campaigns")
  hasApiAccess          Boolean          @default(false) @map("has_api_access")
  
  features              Json             @default("[]")
  
  isPopular             Boolean          @default(false) @map("is_popular")
  displayOrder          Int              @default(0) @map("display_order")
  
  createdAt             DateTime         @default(now()) @map("created_at")

  @@map("subscription_plans")
}

model Invoice {
  id              String   @id @default(uuid())
  brandId         String   @map("brand_id")
  stripeInvoiceId String?  @map("stripe_invoice_id")
  
  amount          Float
  currency        String   @default("EUR")
  status          String
  
  pdfUrl          String?  @map("pdf_url")
  
  periodStart     DateTime? @map("period_start") @db.Date
  periodEnd       DateTime? @map("period_end") @db.Date
  
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("invoices")
}

// ===========================================
// BACK-OFFICE & ADMINISTRATION
// ===========================================

model AdminUser {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  role         String   @default("admin")
  isActive     Boolean  @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("admin_users")
}

model Collection {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?  @map("image_url")
  color       String?
  
  isActive    Boolean  @default(true) @map("is_active")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  displayOrder Int     @default(0) @map("display_order")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  brands      CollectionBrand[]

  @@map("collections")
}

model CollectionBrand {
  collectionId String   @map("collection_id")
  brandId      String   @map("brand_id")
  displayOrder Int      @default(0) @map("display_order")
  addedAt      DateTime @default(now()) @map("added_at")

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  brand      Brand      @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@id([collectionId, brandId])
  @@map("collection_brands")
}

model FeaturedBrand {
  id           String   @id @default(uuid())
  brandId      String   @map("brand_id")
  
  title        String?
  description  String?
  imageUrl     String?  @map("image_url")
  
  featuredType String   @default("weekly") @map("featured_type")
  
  isActive     Boolean  @default(true) @map("is_active")
  startDate    DateTime @map("start_date")
  endDate      DateTime @map("end_date")
  displayOrder Int      @default(0) @map("display_order")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("featured_brands")
}

model TrendingBrand {
  id           String    @id @default(uuid())
  brandId      String    @map("brand_id")
  
  trendScore   Int       @default(0) @map("trend_score")
  reason       String?
  
  isActive     Boolean   @default(true) @map("is_active")
  startDate    DateTime? @map("start_date")
  endDate      DateTime? @map("end_date")
  displayOrder Int       @default(0) @map("display_order")
  
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@map("trending_brands")
}

model SiteSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}